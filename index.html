<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vocabulary Coach ‚Äì Open Source Lab</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
      background: #f0f0f0;
      color: #333;
      transition: all 0.3s;
    }
    .dark-mode {
      background: #121212;
      color: #ddd;
    }
    input, textarea, button {
      font-size: 1rem;
      padding: 0.5rem;
      margin: 0.5rem 0;
      width: 100%;
      box-sizing: border-box;
    }
    .section {
      margin-bottom: 2rem;
    }
    .results, #challenge, #tip, #progressSummary, #wordnikOutput, #coachFeedback {
      background: #e6e6e6;
      padding: 1rem;
      border-radius: 8px;
    }
    .dark-mode .results, .dark-mode #challenge, .dark-mode #tip, .dark-mode #progressSummary, .dark-mode #wordnikOutput, .dark-mode #coachFeedback {
      background: #2b2b2b;
    }
    audio {
      margin-top: 0.5rem;
    }
    .audio-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }
  </style>
</head>
<body>
  <button aria-label="Toggle dark mode" onclick="toggleDarkMode()">üåô/‚òÄÔ∏è</button>
  <h1>Vocabulary Coach ‚Äì Open Source Lab</h1>

  <div class="section" role="region" aria-labelledby="explore-word">
    <h2 id="explore-word">1. Explore a Word</h2>
    <input id="wordInput" placeholder="Type an English word..." aria-label="Word input" autocomplete="off" />
    <button id="analyzeBtn" onclick="analyzeWord()" aria-label="Analyze word">Analyze</button>
    <button id="saveBtn" onclick="saveLearnedWord()" aria-label="Mark word as learned">I learned this today üìå</button>
    <div id="output" class="results" aria-live="polite"></div>
    <div id="wordnikOutput"></div>
    <div id="coachFeedback"></div>
  </div>

  <div class="section" role="region" aria-labelledby="context-practice">
    <h2 id="context-practice">2. Context Practice</h2>
    <textarea id="story" rows="3" placeholder="Write a short story using the word..." aria-label="Write a story"></textarea>
    <textarea id="paraphrase" rows="2" placeholder="Now rewrite it without using the word..." aria-label="Paraphrase the story"></textarea>
    <button onclick="rewriteStory()" aria-label="Rewrite story">üîÅ Ask Coach Alex to rewrite</button>
    <div id="rewriteOutput"></div>
  </div>

  <div class="section" role="region" aria-labelledby="listening-practice">
    <h2 id="listening-practice">3. Listening Practice</h2>
    <button onclick="startRecording()" aria-label="Start recording">üéôÔ∏è Record</button>
    <button onclick="stopRecording()" aria-label="Stop recording">‚èπÔ∏è Stop</button>
    <div id="recordingsList"></div>
  </div>

  <div class="section" role="region" aria-labelledby="daily-challenge">
    <h2 id="daily-challenge">4. Daily Challenge</h2>
    <div id="challenge"></div>
  </div>

  <div class="section" role="region" aria-labelledby="tip-of-day">
    <h2 id="tip-of-day">5. Tip of the Day</h2>
    <div id="tip"></div>
  </div>

  <div class="section" role="region" aria-labelledby="progress-summary">
    <h2 id="progress-summary">üìä Progress Summary</h2>
    <div id="progressSummary"></div>
  </div>

  <script>
    // ====== CONFIGURACI√ìN DE CLAVES API ======
    // ¬°IMPORTANTE! Sustituye por tus claves personales
    const WORDNIK_API_KEY = 'YOUR_WORDNIK_API_KEY';
    const API_NINJAS_KEY = 'fytLoCN2a6ASpU2ez0LLOA==lSBX9fmbuElzjKoL';

    // ====== DATOS Y CONSTANTES ======
    let mediaRecorder, audioChunks = [];

    const tips = [
      "Avoid 'do a mistake'. Say 'make a mistake'.",
      "Use 'run' for managing things: 'run a business'.",
      "'Get' has many meanings: get married, get tired, get ready.",
      "'Look after' means take care of someone or something.",
      "Use 'used to' for past habits: I used to play piano."
    ];

    const challenges = [
      "Say 3 synonyms for a common verb.",
      "Tell a story in past using a phrasal verb.",
      "Say a formal sentence and its informal version.",
      "Use an idiom in a sentence (e.g., break the ice).",
      "Turn a positive sentence into a negative one."
    ];

    // ====== MODO OSCURO ======
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
    }

    // ====== EXPLORAR PALABRA ======
    function analyzeWord() {
      const word = document.getElementById("wordInput").value.trim().toLowerCase();
      if (!word) return;

      // Actualiza enlaces √∫tiles
      const output = document.getElementById("output");
      const links = {
        "üî§ Cambridge Dictionary": `https://dictionary.cambridge.org/dictionary/english/${word}`,
        "üß† Skell Examples": `https://skell.sketchengine.eu/#result?lang=en&query=${word}`,
        "üìö Reverso Context": `https://context.reverso.net/translation/english-spanish/${word}`,
        "üìñ Ludwig.guru": `https://ludwig.guru/s/${word}`,
        "üéß YouGlish": `https://youglish.com/pronounce/${word}/english/us`
      };

      output.innerHTML = `<strong>Word:</strong> ${word}<br><br>`;
      for (const [label, url] of Object.entries(links)) {
        output.innerHTML += `<a href="${url}" target="_blank" rel="noopener">${label}</a><br>`;
      }

      // Limpia la retroalimentaci√≥n previa
      document.getElementById("wordnikOutput").innerHTML = "Loading definitions...";
      document.getElementById("coachFeedback").innerHTML = "";

      // Llama a Wordnik (manejo de errores)
      fetch(`https://api.wordnik.com/v4/word.json/${word}/definitions?limit=2&api_key=${WORDNIK_API_KEY}`)
        .then(res => res.ok ? res.json() : Promise.reject())
        .then(data => {
          const defDiv = document.getElementById("wordnikOutput");
          if (data && data.length > 0) {
            defDiv.innerHTML = `<strong>Definitions from Wordnik:</strong><ul>` +
              data.map(d => `<li>${d.text}</li>`).join('') + `</ul>`;
          } else {
            defDiv.innerHTML = "No definitions found.";
          }
        })
        .catch(() => {
          document.getElementById("wordnikOutput").innerHTML = "Couldn't fetch definitions. Please check your API key.";
        });

      // Llama a API-Ninjas para sin√≥nimos/ant√≥nimos (manejo de errores)
      fetch(`https://api.api-ninjas.com/v1/thesaurus?word=${word}`, {
        headers: { 'X-Api-Key': API_NINJAS_KEY }
      })
        .then(res => res.ok ? res.json() : Promise.reject())
        .then(data => {
          const coach = document.getElementById("coachFeedback");
          if ((data.synonyms && data.synonyms.length) || (data.antonyms && data.antonyms.length)) {
            coach.innerHTML = `üëã Coach Alex says: <br>` +
              (data.synonyms ? `<strong>Synonyms:</strong> ${data.synonyms.join(", ")}<br>` : '') +
              (data.antonyms ? `<strong>Antonyms:</strong> ${data.antonyms.join(", ")}` : '');
          } else {
            coach.innerHTML = `üëã Coach Alex says: No synonyms or antonyms found.`;
          }
        })
        .catch(() => {
          document.getElementById("coachFeedback").innerHTML =
            `üëã Coach Alex says: Nice choice! Don't forget to use '${word}' in a sentence today!`;
        });

      // Actualiza el estado del bot√≥n de guardado
      updateSaveButton();
    }

    // ====== GUARDAR PALABRA APRENDIDA ======
    function saveLearnedWord() {
      const word = document.getElementById("wordInput").value.trim().toLowerCase();
      if (!word) return;
      const learned = JSON.parse(localStorage.getItem("learnedWords") || "[]");
      if (learned.some(w => w.word === word)) {
        alert("You have already saved this word.");
        updateSaveButton();
        return;
      }
      learned.push({ word, date: new Date().toISOString() });
      localStorage.setItem("learnedWords", JSON.stringify(learned));
      updateProgress();
      updateSaveButton();
      alert("Word saved!");
    }

    function updateSaveButton() {
      const word = document.getElementById("wordInput").value.trim().toLowerCase();
      const btn = document.getElementById("saveBtn");
      const learned = JSON.parse(localStorage.getItem("learnedWords") || "[]");
      if (!word || learned.some(w => w.word === word)) {
        btn.disabled = true;
        btn.title = "Word already saved!";
      } else {
        btn.disabled = false;
        btn.title = "";
      }
    }

    // Detecta cambios para actualizar estado del bot√≥n de guardado
    document.getElementById("wordInput").addEventListener("input", updateSaveButton);

    // ====== PR√ÅCTICA DE CONTEXTO ======
    function rewriteStory() {
      const story = document.getElementById("story").value.trim();
      const word = document.getElementById("wordInput").value.trim();
      if (!story) return;
      let rewritten = story;
      if (word) {
        // Reemplaza todas las apariciones de la palabra
        const reg = new RegExp(word, "gi");
        rewritten = rewritten.replace(reg, "...");
      }
      document.getElementById("rewriteOutput").innerHTML =
        `üßë‚Äçüè´ Coach Alex: Here's a better version:<br><em>"${rewritten}"</em><br><small>(In future, this will be powered by AI.)</small>`;
    }

    // ====== GRABACI√ìN DE AUDIO ======
    function startRecording() {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.start();
          audioChunks = [];

          mediaRecorder.addEventListener("dataavailable", event => {
            audioChunks.push(event.data);
          });

          mediaRecorder.addEventListener("stop", () => {
            const audioBlob = new Blob(audioChunks);
            const audioUrl = URL.createObjectURL(audioBlob);
            addRecording(audioUrl);
            saveProgress("recording", audioUrl);
          });
        })
        .catch(() => {
          alert("Microphone access denied or not available.");
        });
    }

    function stopRecording() {
      if (mediaRecorder) mediaRecorder.stop();
    }

    function addRecording(url) {
      const recordingsDiv = document.getElementById("recordingsList");
      const container = document.createElement("div");
      container.className = "audio-item";
      const audio = document.createElement("audio");
      audio.controls = true;
      audio.src = url;

      // Bot√≥n para eliminar grabaci√≥n
      const delBtn = document.createElement("button");
      delBtn.textContent = "üóëÔ∏è";
      delBtn.title = "Delete this recording";
      delBtn.onclick = () => {
        recordingsDiv.removeChild(container);
        removeRecording(url);
      };

      container.appendChild(audio);
      container.appendChild(delBtn);
      recordingsDiv.appendChild(container);
    }

    // Eliminar grabaci√≥n del progreso
    function removeRecording(url) {
      let progress = JSON.parse(localStorage.getItem("progress") || "[]");
      progress = progress.filter(p => !(p.type === "recording" && p.value === url));
      localStorage.setItem("progress", JSON.stringify(progress));
      updateProgress();
    }

    // Cargar grabaciones guardadas al iniciar
    function loadRecordings() {
      const progress = JSON.parse(localStorage.getItem("progress") || "[]");
      const recordings = progress.filter(p => p.type === "recording");
      document.getElementById("recordingsList").innerHTML = "";
      recordings.forEach(r => addRecording(r.value));
    }

    // ====== RETO DIARIO Y TIP DEL D√çA ======
    function randomDaily(seedArray, key, containerId) {
      const today = new Date().toISOString().slice(0, 10);
      const stored = JSON.parse(localStorage.getItem(key)) || {};
      if (stored.date === today) {
        document.getElementById(containerId).innerText = stored.value;
      } else {
        const pick = seedArray[Math.floor(Math.random() * seedArray.length)];
        document.getElementById(containerId).innerText = pick;
        localStorage.setItem(key, JSON.stringify({ date: today, value: pick }));
      }
    }

    // ====== PROGRESO Y LOCALSTORAGE ======
    function saveProgress(type, value) {
      const progress = JSON.parse(localStorage.getItem("progress") || "[]");
      progress.push({ type, value, date: new Date().toISOString() });
      localStorage.setItem("progress", JSON.stringify(progress));
      updateProgress();
    }

    function updateProgress() {
      const learned = JSON.parse(localStorage.getItem("learnedWords") || "[]");
      const progress = JSON.parse(localStorage.getItem("progress") || "[]");
      const words = learned.length;
      const recordings = progress.filter(p => p.type === "recording").length;
      const days = [...new Set(learned.map(w => w.date.slice(0, 10)))].length;

      document.getElementById("progressSummary").innerHTML =
        `Words practiced: <strong>${words}</strong><br>` +
        `Voice recordings: <strong>${recordings}</strong><br>` +
        `Active days: <strong>${days}</strong>`;

      loadRecordings();
    }

    // ====== INICIALIZACI√ìN ======
    window.onload = () => {
      randomDaily(challenges, "dailyChallenge", "challenge");
      randomDaily(tips, "dailyTip", "tip");
      updateProgress();
      updateSaveButton();
    };
  </script>
</body>
</html>
